{
  "version": 3,
  "sources": ["../src/index.ts", "../../shared/src/index.ts", "../src/dep.ts", "../src/effect.ts", "../src/baseHandlers.ts", "../src/reactive.ts"],
  "sourcesContent": ["export { effect } from './effect'\nexport { reactive } from './reactive'\n", "export const isObject = (val: unknown): val is Record<any, any> =>\r\n  typeof val !== null && typeof val === 'object'\r\n\r\nexport const isFunction = (fn: unknown) => typeof fn === 'function'\r\n\r\nexport const isArray = Array.isArray\r\n", "import { ReactiveEffect } from './effect'\r\n\r\nexport type Dep = Set<ReactiveEffect>\r\n\r\nexport const createDep = (effects?: ReactiveEffect[]): Dep => {\r\n  const dep = new Set<ReactiveEffect>(effects)\r\n  return dep\r\n}\r\n", "import { isFunction, isArray } from '@vue/shared'\nimport { createDep, Dep } from './dep'\nimport { TrackOpTypes, TriggerOpTypes } from './operations'\n\n// \u5F53\u524D\u6B63\u5728\u6267\u884C\u7684 effect \u5168\u5C40\u4F7F\u7528\nlet activeEffect: ReactiveEffect | undefined\n\n/**\n * \u4F9D\u8D56\u6536\u96C6\n */\nexport class ReactiveEffect<T = any> {\n  active = true // \u9ED8\u8BA4\u6FC0\u6D3B\u72B6\u6001\n  deps: Dep[] = [] // \u8BA9 effect \u8BB0\u5F55dep\n  parent: ReactiveEffect | undefined = undefined // \u7236 effect \u9ED8\u8BA4null\n\n  constructor(public fn: () => T) {\n    this.fn = fn\n  }\n  // \u6267\u884Ceffect\n  run() {\n    // \u5982\u679C\u662F\u975E\u6FC0\u6D3B\u72B6\u6001 \u6267\u884C\u51FD\u6570 \u4E0D\u9700\u8981\u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\n    if (!this.active) {\n      return this.fn()\n    }\n    // \u5F53\u7EC4\u4EF6\u591A\u5C42\u7EA7\u5D4C\u5957\u65F6 \u4E0D\u4F1A\u51FA\u73B0\u95EE\u9898\n    // vue2 \u4F7F\u7528\u7684\u6808\u7ED3\u6784\u6765\u5904\u7406\u7684 \u524D\u8FDB\u540E\u51FA\n    // \u7B2C\u4E00\u5C42 effect \u6267\u884C parent => undefined activeEffect => \u81EA\u5DF1\n    // \u7B2C\u4E8C\u5C42 effect \u6267\u884C parent => activeEffect(\u7236\u4EB2) activeEffect = \u81EA\u5DF1\n    // \u7B2C\u4E8C\u5C42 effect \u6267\u884C\u5B8C activeEffect => parent(\u7236\u4EB2) parent = undefined\n    // \u6536\u96C6sex \u65F6 activeEffect\u6307\u5411\u7B2C\u4E00\u5C42\n\n    // demo\n    // effect(() => {    e1\n    //   state.name      name=>e1\n    //   effect(() => {  e2\n    //     state.age     age=>e2\n    //   })\n    //   state.sex       sex=>e1\n    // })\n    try {\n      this.parent = activeEffect\n      activeEffect = this as ReactiveEffect\n      // \u5206\u652F\u5207\u6362 \u6E05\u9664effect\n      cleanupEffect(this)\n      return this.fn()\n    } finally {\n      // \u6267\u884C\u5B8C\n      activeEffect = this.parent\n      this.parent = undefined\n    }\n  }\n  stop() {\n    this.active = false\n  }\n}\n\n/**\n * \u6E05\u9664\u4F9D\u8D56\u6536\u96C6\n * @param effect\n */\nfunction cleanupEffect(effect: ReactiveEffect) {\n  const { deps } = effect\n  if (deps.length) {\n    for (let i = 0; i < deps.length; i++) {\n      // deps\u5220\u9664\u4E86effect targetMap\u4E2D\u7684 Set\u4E5F\u5220\u9664\u4E86 \u5229\u7528\u5FAA\u73AF\u5F15\u7528 \u6307\u5411\u540C\u4E00\u5757\u5730\u5740\n      deps[i].delete(effect)\n    }\n    deps.length = 0\n  }\n}\n\n/**\n * \u526F\u4F5C\u7528\u51FD\u6570 \u6B64\u51FD\u6570\u4F9D\u8D56\u7684\u6570\u636E\u53D8\u5316\u4E86 \u4F1A\u91CD\u65B0\u6267\u884C\n * effect\u53EF\u4EE5\u5D4C\u5957\u5199 \u7EC4\u4EF6\u662F\u57FA\u4E8Eeffect\n * @param fn Function\n */\nexport function effect<T = any>(fn: () => T) {\n  if (!isFunction) console.warn('effect \u4F20\u5165\u5FC5\u987B\u662F\u4E00\u4E2A\u51FD\u6570\uFF01')\n  const _effect = new ReactiveEffect(fn)\n  _effect.run()\n  // runner\n  // effect (fn) => runner  runner => fn\n  return _effect.run.bind(_effect)\n}\n\n// \u5B58\u653E\u4F9D\u8D56\u6536\u96C6\u6570\u636E {target -> key -> dep}\n// \u4E00\u4E2Aeffect => \u591A\u4E2A\u5C5E\u6027  \u4E00\u4E2A\u5C5E\u6027 => effect\nconst targetMap = new WeakMap<any, Map<any, Dep>>()\n\n/**\n * \u4F9D\u8D56\u6536\u96C6\n * @param target object \u6536\u96C6\u76EE\u6807\n * @param key unknown \u76EE\u6807\u5143\u7D20\n */\nexport function track(target: object, type: TrackOpTypes, key: unknown) {\n  console.log(type)\n  // \u6CA1\u6709\u5728 effect\u4E2D\u53D6\u503C \u4E0D\u6536\u96C6\n  if (!activeEffect) return\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()))\n  }\n  let dep = depsMap.get(key)\n  if (!dep) {\n    depsMap.set(key, (dep = createDep()))\n  }\n  trackEffects(dep)\n}\n\n/**\n * \u5B58\u653E\u6240\u6709\u7684 effect\n * @param dep Dep\n */\nexport function trackEffects(dep: Dep) {\n  // dep \u662F\u5426 \u9700\u8981\u5B58\u653E effect \u53BB\u91CD\n  // \u5B58\u653E\u8FC7\u7684\u4E0D\u9700\u8981\u8FFD\u52A0 \u53BB\u91CD\u4E86\n  let shouldTrack = false\n  shouldTrack = !dep.has(activeEffect!)\n  if (shouldTrack) {\n    dep.add(activeEffect!)\n    // \u53CC\u5411\u5B58\u50A8\n    activeEffect!.deps.push(dep)\n  }\n}\n\n/**\n * \u89E6\u53D1\u4F9D\u8D56\n * @param target\n * @param key\n */\nexport function trigger(target: object, type: TriggerOpTypes, key: unknown) {\n  console.log(type)\n  const depsMap = targetMap.get(target)\n  // \u770B\u6709\u6CA1\u6709\u6CA1\u8FFD\u8E2A\u8FC7 \u6CA1\u6709\u76F4\u63A5\u4E0D\u505A\u64CD\u4F5C\n  if (!depsMap) return\n  // \u521B\u5EFAdep\u96C6\u5408deps\n  const deps: (Dep | undefined)[] = []\n  const dep = depsMap.get(key)\n  deps.push(dep)\n\n  if (deps.length === 1) {\n    deps[0] && triggerEffects(deps[0])\n  } else {\n    const effects: ReactiveEffect[] = []\n    for (const dep of deps) {\n      dep && effects.push(...dep)\n    }\n    triggerEffects(createDep(effects))\n  }\n}\n\nexport function triggerEffects(dep: Dep | ReactiveEffect[]) {\n  const effects = isArray(dep) ? dep : [...dep]\n  for (const effect of effects) {\n    triggerEffect(effect)\n  }\n}\n\n/**\n * \u91CD\u65B0\u6267\u884Ceffect\n * @param effect\n */\nfunction triggerEffect(effect: ReactiveEffect) {\n  // \u9632\u6B62\u5728effect \u653E\u5165\u81EA\u5DF1 \u9020\u6210\u6B7B\u5FAA\u73AF\n  // effect(() => {\n  //   state.age = Math.random()\n  // })\n  if (effect !== activeEffect) {\n    console.log(effect)\n    console.log(activeEffect)\n    effect.run()\n  }\n}\n", "import { track, trigger } from './effect'\nimport { TrackOpTypes, TriggerOpTypes } from './operations'\nimport { ReactiveFlags } from './reactive'\n\n// \u4E3A\u4EC0\u4E48\u7528 Reflect\n// \u5F53 \u83B7\u53D6age \u65F6\u8981\u6536\u96C6name name\u53D8\u5316\u4E86 age\u4E5F\u8981\u91CD\u65B0\u8BA1\u7B97\n// \u5982\u679C\u5728\u539F\u59CB\u5BF9\u8C61\u53D6age \u662F\u4E0D\u4F1A\u5BF9name \u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\n// const user = {\n//   name: 'mz',\n//   get age() {\n//     return this.name\n//   }\n// }\n\nexport const mutableHandlers: ProxyHandler<object> = {\n  get(target, key, receiver) {\n    // \u63A7\u5236 \u5DF2\u7ECF\u88AB\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61 flag\n    if (key === ReactiveFlags.IS_REACTIVE) return true\n    // \u6536\u96C6\u4F9D\u8D56\n    track(target, TrackOpTypes.GET, key)\n    return Reflect.get(target, key, receiver)\n  },\n  set(target, key, value) {\n    const oldValue = (target as any)[key]\n    const result = Reflect.set(target, key, value)\n    // \u5982\u679C\u65B0\u503C\u7B49\u4E8E\u65E7\u503C \u5219\u4E0D\u9700\u8981\u66F4\u65B0\n    if (oldValue !== value) {\n      // \u89E6\u53D1\u4F9D\u8D56\n      trigger(target, TriggerOpTypes.SET, key)\n    }\n    return result\n  }\n}\n", "import { isObject } from '@vue/shared'\nimport { mutableHandlers } from './baseHandlers'\n\nexport const enum ReactiveFlags {\n  IS_REACTIVE = '__v_isReactive'\n}\nexport interface Target {\n  [ReactiveFlags.IS_REACTIVE]?: boolean\n}\n\n// \u5B58\u653E\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61\nexport const reactiveMap = new WeakMap<Target, any>()\n\n/**\n * \u5C06\u5BF9\u8C61\u53D8\u4E3A\u54CD\u5E94\u5F0F proxy\n * @param target\n * @returns\n */\nexport function reactive(target: any) {\n  return createReactiveObject(target)\n}\n\nfunction createReactiveObject(target: any) {\n  // \u5982\u679C\u4F20\u5165\u7684\u4E0D\u662F\u4E00\u4E2A\u5BF9\u8C61 Proxy\u7528\u4E8E\u521B\u5EFA\u4E00\u4E2A\u5BF9\u8C61\u7684\u4EE3\u7406\n  if (!isObject) {\n    console.warn('\u54CD\u5E94\u5F0F\u5143\u7D20\u5FC5\u987B\u662F\u4E00\u4E2A\u5BF9\u8C61\uFF01')\n    return target\n  }\n  // \u76EE\u6807\u5DF2\u7ECF\u6709\u76F8\u5E94\u7684\u4EE3\u7406 \u76F4\u63A5\u8FD4\u56DE\u88AB\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61\n  const existingProxy = reactiveMap.get(target)\n  if (existingProxy) {\n    return existingProxy\n  }\n  // \u5982\u679C\u4F20\u7684\u662Fproxy\n  // \u7B2C\u4E00\u6B21\u4F20\u5165\u7684\u666E\u901A\u5BF9\u8C61 \u8FD8\u6CA1\u6709\u8D70get\u65F6\u5019\u8BBF\u95EE\u662Ffalse\n  if (target[ReactiveFlags.IS_REACTIVE]) {\n    return target\n  }\n  const proxy = new Proxy(target, mutableHandlers)\n  // \u5B58\u50A8proxy\n  reactiveMap.set(target, proxy)\n  return proxy\n}\n"],
  "mappings": "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",
  "names": ["effect", "dep"]
}
